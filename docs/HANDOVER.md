# TradeMind 工作日志

> 增量更新：今天做了什么，接下来要做什么  
> **最后更新**: 2026-02-20

---

## ✅ 今日完成 (2026-02-20) - W2 完成

### LLM 单兵变体系统
- **三种变体实现**: Lite / Indicator / Strategy
  - Lite: 24h 价格 CSV（基础）
  - Indicator: 价格 + RSI/SMA/MACD 当前值 + **24h 指标历史**
  - Strategy: Indicator + 日线 + 策略建议（评分0-10）
- **Arena UI 平铺显示**: 默认显示三种 LLM 变体，可独立配置
- **配置持久化**: `.env.local` 支持 MiniMax API Key

### 日志系统增强
- **状态日志**: 每次 Tick 记录价格、BTC 持仓、USDT 余额、总权益
- **决策日志**: 记录 LLM 决策 + 可折叠的 Prompt/Response
- **前端展示**: 实时日志面板显示仓位变化和 LLM 输入输出

### 图表优化
- **Tooltip 修复**: 显示 BTC 持仓数量和 USDT 余额（不再是0）
- **Tooltip 持久化修复**: 鼠标离开图表区域自动隐藏

### 分析层 Tools
- `analysis-tools.ts`: RSI/SMA/EMA/MACD 计算函数
- `createAnalysisTools`: 服务端 Tool 注册
- 24h 指标历史计算（每根小时线的指标值）

### 默认配置调整
- 步长: 15分钟 → **720分钟（12小时）**
- DCA 间隔: 1440分钟 → **10080分钟（7天）**

### 测试
- 24+ 个单元测试全部通过
- Playwright 集成测试验证 UI 交互

---

## ✅ 今日完成 (2026-02-20) - 策略验证与优化

### Indicator 提示词优化
- **问题发现**: Lite（数据少）反而胜出，Indicator/Strategy 过于保守
- **根因分析**: RSI 30/70 阈值限制，错过震荡行情机会
- **解决方案**: 移除硬性规则，改为开放式提示词
  - 旧: "RSI(超买>70/超卖<30)"
  - 新: "RSI(14)：衡量价格强弱(0-100)，自主判断"
- **效果**: 给予 LLM 更大决策自由度

### 新增 LLM-Scalper 高频波段选手
- **定位**: 高频波段，积少成多
- **数据输入**: Indicator 级别（RSI/SMA/MACD + 24h历史）
- **交易理念**: 
  - 小利即出，逢低吸纳
  - 自主决策，没有固定阈值束缚
- **输入数据特色**: 
  - 浮盈亏状态
  - 24h价格区间位置
  - 分析角度参考（非规则）

### 回测验证结果（7天，步长12小时）
| 选手 | 收益率 | 表现 |
|------|--------|------|
| DCA | -3.78% | 基准 |
| Scalper | -6.29% | ❌ 跑输 DCA |

**初步结论**: 
- 12小时步长可能过长，错过日内波段
- 2025年初行情可能不适合高频策略
- 需进一步诊断交易记录

### Arena 历史存档系统
- 创建 `docs/arena-history/` 目录结构
- 设计比赛数据导出功能（JSON格式）
- 模板化报告格式（report.md + config.json + data.json）

### 配置面板功能规划（Future - 非紧急）
- 记录详细设计文档: `docs/todo/future-arena-config-panel.md`
- 功能: 基于模板创建自定义选手，微调数据输入和提示词
- **状态**: 待 LLM 策略验证有效后实现

---

## ✅ 历史完成

### 2026-02-20
- **Arena 实时图表优化**: 修改 `RaceController` 采集频率为每步更新，修复大步长回测图表断流问题。
- **净值计算逻辑修复**: 实现全局资产定时重估（Global Revaluation），解决选手持仓不交易时净值曲线呈横线的 Bug。
- **MiniMax API 深度优化**:
    - 切换为性价比模型 `MiniMax-Text-01`。
    - 引入极简 CSV 数据格式，单次 Token 消耗降低 60%。
    - 实现 1m 数据手动聚合为 1h 采样逻辑，解决 LLM 获取不到价格数据的 Bug。
- **架构共识确立**: 明确"数据层-分析层-信号层"三层架构及"双模块驱动（外部泵 vs 内部心脏）"逻辑。
- **文档重构**: 更新了 VISION.md 和 ROADMAP.md，将协作效率验证作为 v0.1 核心指标。
- **Git 同步**: 成功将代码库更新至最新版本，修复了 .gitignore 格式问题。

### 2026-02-19
- 架构决策：确认将架构改为"虚拟时钟注入"模式（方案 B），提升回测与实盘的统一性。
- 架构分析：明确 FeedBus 的定位为 MAS 内部观点共享机制，数据层由 DB 控制时间边界提供。
- 文档更新：创建了 [ADR-003-backtest-framework.md](./architecture/ADR-003-backtest-framework.md) 记录回测框架设计。
- 规划实现：制定了包含 VirtualClock、Contestant 接口及 RaceController 的实现计划。

### 2026-02-18
- 文档系统重构：创建 VISION.md、ROADMAP.md，归档过时文档
- 架构设计：创建 ADR-002 预测闭环、量化指标指南
- 项目启动验证：代码运行成功，图表页面正常
- 修复 cfo.ts 导入错误

---

## 📋 接下来要做 (W3)

### 竞技场代码优化与修复 (2026-02-20)
- **MACD 精准化**: 修复金叉死叉逻辑 Bug，提升策略信号可靠性。
- **资产系统增强**: 实现了已实现盈亏统计 (Realized PnL) 及资产评估指标补全。
- **性能革命**: 将指标历史计算复杂度从 O(N^2) 降至 O(N)，扫清全年回测障碍。
- **档案同步**: 建立了 `docs/todo/history` 体系，归档了 [回测竞技场 Bug 修复历史报告](./todo/history/2026-02-20_backtest_bug_fix.md)。

---

## 📋 接下来要做 (W3)

### 紧急：诊断 Scalper 为什么跑输 DCA
- [ ] **查看交易记录**: Scalper 在 12h 步长下交易了几次？胜率多少？
- [ ] **分析权益曲线**: 是满仓被套还是频繁割肉？
- [ ] **对比实验**: 步长 720分钟 vs 60分钟，验证交易频率影响
- [ ] **行情适配**: 测试不同市场环境（上涨/下跌/震荡）下各选手表现

### 重要：LLM 策略优化
- [ ] **数据验证**: 确认 2025 全年 BTC 行情特征（趋势/震荡比例）
- [ ] **策略调优**: 基于交易记录调整提示词（更激进 or 加止损）
- [ ] **对比基准**: Lite vs Indicator vs Scalper 同条件对比

### 计划：基础设施
- [ ] **2025 全年回测跑通**: 拿到全年度竞技场 Baseline 数据。
- [ ] **评估系统**: 计算夏普比率、最大回撤等进阶指标。
- [ ] **LLM 策略增强 (W3)**: 引入 Few-shot 学习和决策反思逻辑。
- [ ] **MAS 小队运转**: 技术分析员信号生成 + PA 决策 + 交易执行。

### Future（非紧急）
- [ ] **配置面板**: 选手自定义配置系统（已设计，待实现）
