# Insight 001: LLM 决策 Pipeline 拆解与优化方向

> **类型**: 方向性探索  
> **创建日期**: 2026-02-21  
> **状态**: 讨论中  
> **相关**: HANDOVER.md (W3 进行中), ADR-001 Agent Framework

---

## 背景

基础数据会随时间增长，一次 LLM 决策周期包含多个可调环节。需要拆解这些环节，理清各自的职责、可调节空间和优先级，以便**控制变量法**逐项优化。

---

## Pipeline 环节拆解

### 0️⃣ 数据源种类

**现状**: 仅 K 线数据。

**可扩展方向**:
- **链上数据**: 巨鲸钱包异动、交易所净流入流出、资金费率（Funding Rate）
- **舆情 / 新闻**: Twitter/X 情绪指数、重大事件（ETF 审批、监管政策）
- **市场结构**: OrderBook 深度、清算热力图、持仓量（Open Interest）

**特性**: 各数据源之间独立性强，可逐个接入，不需要一次性全上。

---

### 1️⃣ 输入数据粒度

**核心问题**: 给 LLM 看小时线、15 分钟线、日线、还是全部？

**需要权衡的维度**:
- **信息密度 vs Token 成本**: W2 实验已证明 Lite（数据少）反而可能胜出
- **时间窗口**: 最近 24h / 7 天 / 30 天？
- **多周期融合**: 日线看趋势 + 1h 线看入场点（专业交易员的标准做法），但如何压缩给 LLM 是设计难题
- **指标型数据**: RSI / SMA / MACD 等经过计算后的衍生指标

---

### 2️⃣ 数据表达 / 编码方式

**核心问题**: 同样的数据，用什么方式表述给 LLM？

**可调节角度**:
- **原始数值** vs **语义化描述**
  - 原始: "RSI=72"
  - 语义化: "RSI 进入超买区间，过去 4 小时持续走高"
- **K线几何意义 / 模式识别前置**: 先检测出"头肩顶"、"双底"等形态，输入给 LLM 的就不是原始 K 线，而是形态判断结果
- **比较性描述**: "当前价格处于 30 日区间的 85% 分位" 比 "价格 93500" 对 LLM 更有决策价值

**洞察**: 这一层本质上是在翻译"人类交易员看盘时脑子里想的东西"。**投入最低、杠杆最高**。

---

### 3️⃣ LLM 提示词 / 思维框架

**核心问题**: 如何引导 LLM 的推理方式？

**可调节角度**:
- **角色设定**: 保守型 vs 激进型、趋势跟踪 vs 逆势交易
- **推理框架**: OODA Loop、CoT（链式思考）、多步推理
- **记忆 / 上下文**: 上一次决策是什么？持仓成本？连续亏损几次了？（避免重复犯错）
- **主动请求能力**（Agent 模式核心）: LLM 不是被动接收数据，而是自己决定"我还需要看什么"
- **Few-shot 范例**: 经典交易场景示范（Scalper 已在实验中）

---

### 4️⃣ LLM 输出 / 决策格式

**现状**: 输出买/卖/持有 + 理由。

**可扩展方向**:
- **置信度**: 不仅输出"买"，还要输出"我有多确定"（影响仓位大小）
- **仓位比例**: 买多少？全仓还是 25%？
- **决策理由**: 结构化输出，便于追溯和复盘
- **多步计划**: "现在买 25%，如果跌到 X 再加仓 25%"

---

### 5️⃣ 交易指令丰富度

**现状**: 仅现货买/卖/等待。

**可扩展方向**:
- **条件单**（Conditional Order）: 到价触发
- **止盈止损**（TP/SL）: 最基础的风控
- **追踪止损**（Trailing Stop）: 锁定利润
- **分批建仓/平仓**: DCA 进场、分批止盈

**本质**: 扩展 LLM 的行动空间（Action Space）。

---

### 6️⃣ 反馈 / 复盘环节 ⚡ 补充

**现状**: 缺失。

**目标**:
- 决策执行后的**结果反馈**回给 LLM：这笔交易赚了还是亏了？
- **决策质量评估**: 不看结果看过程（正确的逻辑亏钱也是好决策）
- **策略适应性**: 市场从震荡切换到趋势了，策略要不要自动调整？

**意义**: 这个闭环是从"单次决策"进化到"持续学习"的关键。

---

## 优先级建议

按**投入产出比**排序：

| 优先级 | 环节 | 理由 |
|--------|------|------|
| ⭐⭐⭐ | 2️⃣ 数据表达方式 | 最低成本、最高杠杆。同样的数据换个表达，LLM 理解力可能天差地别。改编码方式几乎零成本。 |
| ⭐⭐⭐ | 3️⃣ 提示词 + 记忆 | 和 2 配合，Few-shot + 上下文记忆对决策质量影响巨大。Scalper 的 Few-shot 实验已在进行。 |
| ⭐⭐ | 1️⃣ 多周期数据融合 | 日线趋势 + 1h 入场信号结合，交易员基本功。Strategy 变体已在做日线，可深化。 |
| ⭐⭐ | 5️⃣ 交易指令丰富化 | 止盈止损是核心风控，没有它 Scalper 即使判断对了也可能"坐过山车"亏回去。 |
| ⭐ | 6️⃣ 反馈闭环 | 重要但可后做。先把单次决策质量提上来。 |
| ⭐ | 0️⃣ 新数据源 | 接入成本高、数据质量不确定。在 K 线上把 pipeline 打磨好再扩展更稳。 |

---

## 核心原则

> **每个环节都是正交的** —— 改数据表达方式不影响交易指令格式，改提示词不需要动数据源。可以把每个环节当作独立变量，控制变量法逐个调优。

**推荐路径**: 先在现有 K 线数据源上，把 **2（数据表达）** 和 **3（提示词）** 打磨到极致（ROI 最高），等稳定后再扩展 1（多周期）和 5（交易指令），最后接入新数据源。
